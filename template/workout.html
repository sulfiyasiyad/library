def issue_book(request,issueID):
    issues=Issue.objects.get(id=issueID)
    issues.issued=True
    orderbook=Book.objects.filter(id=issues.book.id).first()
    orderbook.book_stock= orderbook.book_stock-issues.quantity
    orderbook.save()
    issues.save()
    return redirect('requestedissues')

def requestedissues(request):
    totalbook=0
    iss=Issue.objects.filter(user_id=request.user.id)
    totalbook=sum(item.quantity for item in iss)
    
    total=Usermember.objects.all().filter(status=0).count()
    if request.GET.get('user_id') is not None and request.GET.get('user_id') != '':
        try:
            user= User.objects.get(username=request.GET.get('user_id'))
            student=Usermember.objects.filter(user_id=user)
            if student:
                user=user[0]
                issues=Issue.objects.filter(user=user,issued=False)
                return render(request,'allissues.html',{'issues':issues,'totalbook':totalbook})
            messages.error(request,'No Student found')
            return redirect('allissues') 
        except User.DoesNotExist:
            messages.error(request,'user not found')
            return redirect('allissues')

    else:
        issues=Issue.objects.filter(issued=False)
        return render(request,'allissues.html',{'issues':issues,'total':total,'totalbook':totalbook})
def view_issuebook(request):
    if Usermember.objects.filter(user_id=request.user):
        user1=Usermember.objects.filter(user_id=request.user)[0]
        
        if request.GET.get('issued') is not None:
            issues=Issue.objects.filter(user=request.user,issued=True)
        elif request.GET.get('notissued') is not None:
            issues=Issue.objects.filter(user=request.user,issued=False)
        else:
            issues=Issue.objects.filter(user=request.user)
        return render(request,'myissues.html',{'issues':issues})
    
    return redirect('/')

def main_return(request):
    total=0
    cart_item=Cart.objects.filter(user=request.user)
    total=sum(item.quantity for item in cart_item)
    if Usermember.objects.filter(user_id=request.user):
        user1=Usermember.objects.filter(user_id=request.user)[0]
        
        if request.GET.get('issued') is not None:
            issues=Issue.objects.filter(user=request.user,issued=True)
        else:
            issues=Issue.objects.filter(user=request.user)
        return render(request,'return_book.html',{'issues':issues,'total':total})
        
    messages.error(request,'You are Not a user !')
def return_book(request,issueID):
    issue=Issue.objects.get(id=issueID)
    calcFine(issue)
    issue.returned=True
    orderbook=Book.objects.filter(id=issue.book.id).first()
    orderbook.book_stock= orderbook.book_stock+issue.quantity
    orderbook.save()
    issue.save()
    return redirect('main_return')
    # return render(request,'return_book.html',{'issue':issue})
def calcFine(issue):
    "Calculate fines of each issue if any"
    if(issue.issued==True and issue.returned==False):
        y,m,d=str(timezone.now().date()).split('-')
        today=datetime.date(int(y),int(m),int(d))
        print(today)
        y2,m2,d2=str(issue.returndate).split('-')
        print(y2,m2,d2)
        lastdate=datetime.date(int(y),int(m2),int(d2))
        print(lastdate)
        fine=Issue()
        if(today>lastdate):
            diff=today-lastdate 
           
            if not fine.paid:
                fine.amount=diff.days*10
                fine.save()
            else:
                print('fine paid')
        else:
            a='no fine'
            fine.amount=a
    else:
        print('no fine')
        path('issuebook/<int:issueID>/',views.issue_book,name='issue_book'),
            path('requestedissues',views.requestedissues,name='requestedissues'),
            path('view_issuedbook',views.view_issuebook,name='view_issuedbook'),
            path('return_book/<int:issueID>/',views.return_book,name='return_book'),
            path('main_return',views.main_return,name='main_return'),
        
 <!-- {% for item in a %}
{{item.book.book_name}}
{{item.quantity}}
{{item.damage}}
{{item.fine}}
<a href="{% url 'checkout_pay' %}">
<button type="submit" value="pay">Pay</button></a>
{% empty %}
<h1>Not found</h1>
{% endfor %}  -->
<div class="col-lg-9 col-md-8" style="margin-top: 80px;" >
    <div class="table-responsive">
        <table class="table table-striped">
            <thead class="thead-inverse">
              <tr>
                <th scope="col">Book</th>
                <th scope="col">Quantity</th>  
                <th scope="col"> Rent Price</th>
                <th scope="col"> Fine</th>            
              </tr>
            </thead>
            <tbody>
              {% for d in lost %}
              <tr>
                <td>{{d.book.book_name}}</td>
                <td>{{d.quantity}}</td>
                  
                <td>{{d.book.book_rent}}</td>
                  <!-- <td><a href="{% url 'lost_fine' d.id %}">Add</a></td> -->
                <td>
  
                </td>
              </tr>
              {% endfor %}
            </tbody>
        </table>
      </div>
    </div>
    def lost(request):
    total=0
    cart=Cart.objects.filter(user_id=request.user.id)
    total=sum(item.quantity for item in cart)
    if Usermember.objects.filter(user_id=request.user):
        issues=Requestbook.objects.filter(user=request.user,issued=True,returned=False)
        
        return render(request,'lost.html',{'issues':issues,'total':total})
def lost_send(request,pk):
    neworderitems=Requestbook.objects.filter(id=pk)
    for item in neworderitems:
        a=Lost(book=item.book,user=request.user,quantity=item.quantity)
        a.save()
       
        neworderitems.delete()
        messages.info(request,'Your Request was Sended Sucessfully')
    return redirect('lost')
def admin_lost(request):
    a=Lost.objects.all().filter(status=0)
    messages.info(request,"fine added sucessfully")
    return render(request,'admin_lost.html',{'lost':a})
def lost_fine(request,pk):
    order2=Lost.objects.all().filter(id=pk)
    return render(request,'lost_fine.html',{'order1':order2})
def add_fine(request,pk):
    newone=Lost.objects.get(id=pk)
    newone.status=True
    if request.method=='POST':
        newone.fine=request.POST['n1']
        newone.damage=request.POST['n2']
        newone.save()
        newone.subtotal=(newone.book.book_price + int(newone.fine))*newone.quantity
        newone.save()
    return redirect('admin_lost')


def pay_fine(request):
    total=0
    cart=Cart.objects.filter(user_id=request.user.id)
    total=sum(item.quantity for item in cart)
    total1=0
    cart_item=Lost.objects.filter(user=request.user,status=1)
    total1=sum(item.quantity for item in cart_item)
    cartitem=Lost.objects.all().filter(user=request.user)
    for item in cartitem:
         if item.quantity >item.book.book_stock:
              a=Lost.objects.get(id=item.id)
    rawcart=Lost.objects.filter(user=request.user)
    total_price=0
    for item in rawcart:
         total_price=total_price+item.fine*item.quantity+item.book.book_price 
         



    return render(request,'viewlost_fine.html',{'a':rawcart,'total_price':total_price,'total1':total1,'total':total})
   




def checkout_pay(request):
    usermember1=Usermember.objects.get(user=request.user)
    rawcart=Lost.objects.filter(user=request.user)
    order=Paydetails.objects.filter(user=request.user)
    for item in rawcart:
        if item.quantity > item.book.book_stock:
            a=Lost.objects.get(id=item.id)
            a.delete()
    cartitems=Lost.objects.filter(user=request.user,status=1)
    total_price=0
    for item in cartitems:
        total_price=total_price+item.fine*item.quantity+item.book.book_price       
    return render(request,'pay.html',{'cartitems':cartitems,'total_price':total_price,'usermember1':usermember1})
     
     
def paydetails(request):
    if request.method=='POST':
            neworder=Paydetails()
            neworder.user=request.user
            neworder.fname=request.POST['n1']
            neworder.lname=request.POST['n2']
            neworder.Email=request.POST['n3'] 
            neworder.phone=request.POST['n5']
            cart=Lost.objects.filter(user=request.user,status=1)
            cart_total_price=0 
            for item in cart:
                cart_total_price=cart_total_price+item.fine*item.quantity+item.book.book_price
                neworder.total_price=cart_total_price
            neworder.save()
            neworderitems=Lost.objects.filter(user=request.user,status=1)
            for item in neworderitems:
             
                Payment.objects.create(paydetails=neworder,book=item.book,quantity=item.quantity)
                orderbook = Book.objects.filter(id=item.book.id).first()
                orderbook.book_stock= orderbook.book_stock-item.quantity
                orderbook.save()
            Lost.objects.filter(user=request.user,status=1).delete()
            
    
            messages.success(request,' Thanku payment was done sucessfully')
    return redirect('checkout_pay')
    <style>
        body {
        font-family: 'Roboto Condensed', sans-serif;
        
    }
    
    /* .hedding {
        font-size: 20px;
        color: #ab8181`;
    } */
    

    
    .left-side-product-box img {
        width: 100%;
    }
    
    .left-side-product-box .sub-img img {
        margin-top: 5px;
        width: 83px;
        height: 100px;
    }
    
    .right-side-pro-detail span {
        font-size: 15px;
    }
    
    .right-side-pro-detail p {
        font-size: 25px;
        color: #a1a1a1;
    }
    
    .right-side-pro-detail .price-pro {
        color: #E45641;
    }
    
    .right-side-pro-detail .tag-section {
        font-size: 18px;
        color: #5D4C46;
    }
    
    .pro-box-section .pro-box img {
        width: 100%;
        height: 200px;
    }
    
    @media (min-width:360px) and (max-width:640px) {
        .pro-box-section .pro-box img {
            height: auto;
        }
    }
    </style>
    {% if book.tag %}
    {{products.tag}}
    {% endif %}
    <div class="container">
        <div class="col-lg-8 border p-3 main-section bg-white">
            <div class="row hedding m-0 pl-3 pt-0 pb-3"></div>
            <div class="row m-0">
                <div class="col-lg-4 left-side-product-box pb-3">
                    <img src="{{book.Image.url}}" class="border p-3" style="height: 350px;">
                        <!-- <span class="sub-img">
                            <img src="http://nicesnippets.com/demo/pd-image2.jpg" class="border p-2">
                            <img src="http://nicesnippets.com/demo/pd-image3.jpg" class="border p-2">
                            <img src="http://nicesnippets.com/demo/pd-image4.jpg" class="border p-2">
                        </span> -->
                </div>
                <div class="col-lg-8">
                    <div class="right-side-pro-detail border p-3 m-0">
                        <div class="row">
                            <div class="col-lg-12">
                                <span></span>
                                    <p class="m-0 p-0">{{book.book_name}}</p>
                            </div>
                            <div class="col-lg-12">
                                    <p class="m-0 p-0 price-pro">₹{{book.book_price}}</p> 
                                    <p class="m-0 p-0 price-pro">Rent Price:₹{{book.book_rent}}</p>
    
                                    <hr class="p-0 m-0">
                            </div>
                            <div class="col-lg-12 pt-2">
                                    <h5>Book Detail</h5>
                                    <span>{{book.book_description}}</span>
                                    <hr class="m-0 pt-2 mt-2">
                            </div>
                            {% if book.book_stock <= 0  %}
                            <div class="col-lg-12 mt-3">
                                <div class="row">
                                    <div class="col-lg-6 pb-2">
                                        <h5 style="color: red;"> out of stock</h5>
                            {% else %}
                            <div class="col-lg-6 pb-2">
                                <h5 style="color: green;">Available </h5>
                                <a href="{% url 'add_cart' book.id %}" class="btn btn-danger w-100">Add To Cart</a>
                            </div>
                            <div class="col-lg-6" style=" margin-top: 30px;">
                                <a href="{% url 'rent' book.id %}" class="btn btn-success w-100">Rent Now</a>
                            </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        
    
    
      
        